<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ママはひだりから数えてなんばんめ？</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50%25' x='50%25' dominant-baseline='central' text-anchor='middle' font-size='54'%3E🙋‍♀️%3C/text%3E%3C/svg%3E">
  <style>
    body{font-family:sans-serif;text-align:center;padding:20px;background:#fafafa;max-width:640px;margin:0 auto;}
    #hero{font-size:24px;line-height:24px;height:24px;margin:10px 0; overflow: hidden;}  /* サイズ縮小 */
    #line{display:flex;flex-wrap:wrap;justify-content:center;margin:20px 0;gap:6px;}
    .person{width:44px;height:44px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:default;user-select:none;box-shadow:0 1px 2px rgba(0,0,0,.2);}    
    #timer{font-size:26px;font-weight:bold;margin:10px;visibility:hidden;}
    #score{margin:10px;font-weight:bold;font-size:20px;}
    #options{display:flex;justify-content:center;gap:16px;margin-top:16px;flex-wrap:wrap;}
    .optBtn{padding:16px 32px;font-size:24px;border:none;border-radius:10px;background:#2196f3;color:#fff;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,.2);}    
    .optBtn:hover{filter:brightness(1.1);}  
    .optBtn.disabled{pointer-events:none;opacity:0.6;}
    #startBtn{padding:14px 32px;font-size:22px;border:none;border-radius:10px;background:#4caf50;color:#fff;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,.25);}    
    #startBtn:hover{filter:brightness(1.1);}  
    #ranking{margin-top:30px;text-align:left;}
    #ranking h2{font-size:22px;margin-bottom:6px;}
    #lbHeader{font-weight:bold;margin-bottom:4px;padding-left:20px;}
    #leaderboard{padding-left:20px;}
    #resetBtn{margin-left:20px;margin-top:10px;padding:6px 16px;font-size:14px;background:#e53935;color:white;border:none;border-radius:6px;cursor:pointer;}
    #nameInputContainer{margin-top:20px; display:none;}
    #nameInputContainer input[type="text"]{padding:10px;font-size:18px;border:1px solid #ccc; border-radius:5px; margin-right:10px;}
    #nameInputContainer button{padding:10px 20px;font-size:18px;border:none;border-radius:5px;background:#2196f3;color:#fff;cursor:pointer;}
    #nameInputContainer button:hover{filter:brightness(1.1);}
  </style>
</head>
<body>
<h1>ママはひだりから数えてなんばんめ？</h1>
<div id="hero" aria-label="挙手する女性">🙋‍♀️</div>
<div id="score">スコア: 0</div>
<div id="timer">のこりじかん 0秒</div>
<div id="line"></div>
<div id="options"></div>
<button id="startBtn">スタート</button>

<div id="nameInputContainer">
  <p>ハイスコア！名前を入力してください:</p>
  <input type="text" id="playerNameInput" placeholder="なまえ">
  <button id="submitNameBtn">登録</button>
</div>

<section id="ranking">
  <h2>ランキング</h2>
  <div id="lbHeader">名前 ⋯ スコア ⋯ 平均反応速度</div>
  <ol id="leaderboard"></ol>
  <button id="resetBtn">ランキングをリセット</button>
</section>

<script>
(() => {
  const lineEl    = document.getElementById('line');
  const timerEl   = document.getElementById('timer');
  const scoreEl   = document.getElementById('score');
  const optionsEl = document.getElementById('options');
  const startBtn  = document.getElementById('startBtn');
  const lbList    = document.getElementById('leaderboard');
  const rankingEl = document.getElementById('ranking');
  const resetBtn  = document.getElementById('resetBtn');
  const nameInputContainer = document.getElementById('nameInputContainer');
  const playerNameInput = document.getElementById('playerNameInput');
  const submitNameBtn = document.getElementById('submitNameBtn');

  const MALE='👨', FEMALE='🙋‍♀️', ANIMALS=['🐼','🐮','🐷','🐥'];
  const correctSoundSrc='correct.mp3', wrongSoundSrc='wrong.mp3';
  const LB_KEY='mama_leaderboard', LASTNAME_KEY='mama_last_name';

  let level, peopleNum, score, targetIndex, timeLeft, timerId, lockInput=false;
  let reactTimes=[]; let questionStart=0; let gameEnded = false;
  const SEP=' ⋯ ';
  let currentAvgRT = 0;

  const correctAudio = new Audio(correctSoundSrc);
  const wrongAudio   = new Audio(wrongSoundSrc);
  const play = (audio) => {
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  };

  const loadLB = () => { try{return JSON.parse(localStorage.getItem(LB_KEY))||[]}catch{return[]} };
  const saveLB = arr => localStorage.setItem(LB_KEY, JSON.stringify(arr));
  const renderLB = () => { lbList.innerHTML=''; loadLB().forEach(e=>{ const li=document.createElement('li'); const rt = e.avg? `${e.avg.toFixed(2)}s` : '--'; li.textContent=`${e.name}${SEP}${e.score} 点${SEP}${rt}`; lbList.appendChild(li); }); };
  const qualifies = s => { const lb=loadLB(); return s>0&&(lb.length<10||s>lb[lb.length-1].score); };
  const recordHS = (n,s,avg) => {
    if (!n) return;
    const lb=loadLB();
    lb.push({name:n,score:s,avg});
    lb.sort((a,b)=>b.score-a.score);
    if(lb.length>10) lb.length=10;
    saveLB(lb);
  };

  function initGame(){
    startBtn.style.display='none';
    rankingEl.style.display='none';
    nameInputContainer.style.display = 'none';
    timerEl.style.visibility='visible';
    level=1;
    peopleNum=8;
    score=0;
    reactTimes=[];
    lockInput=false;
    gameEnded = false;
    updScore();
    nextQ();
  }
  const updScore = () => scoreEl.textContent = `スコア: ${score}`;

  function renderLine(){ lineEl.innerHTML=''; const ac=Math.floor(score/5),idxSet=new Set(); while(idxSet.size<ac){ const i=Math.floor(Math.random()*peopleNum); if(i!==targetIndex) idxSet.add(i);} let pick=0; for(let i=0;i<peopleNum;i++){ const d=document.createElement('div'); d.className='person'; d.textContent = (i===targetIndex)?FEMALE : idxSet.has(i)?ANIMALS[pick++%ANIMALS.length] : MALE; lineEl.appendChild(d);} }

  function startTimer(sec){
    clearInterval(timerId);
    timeLeft=sec;
    updTimer();
    timerId=setInterval(()=>{
      timeLeft=Math.max(0,timeLeft-0.1);
      updTimer();
      if(timeLeft<=0 && !gameEnded){
        clearInterval(timerId);
        lockInput = true;
        gameEnded = true;
        play(wrongAudio);
        setTimeout(()=>gameOver(false), 600);
      }
    },100);
  }  
  const updTimer = () => { timerEl.textContent = `のこりじかん ${timeLeft.toFixed(1)}秒`; };

  function renderOpts(){ optionsEl.innerHTML=''; const cor=targetIndex+1; const opts=new Set([cor]); while(opts.size<4){ const n=cor+Math.floor(Math.random()*11)-5; if(n>=1&&n<=peopleNum) opts.add(n);} [...opts].sort((a,b)=>a-b).forEach(n=>{ const btn=document.createElement('button'); btn.className='optBtn'; btn.textContent=n; btn.dataset.val=n; btn.addEventListener('click',onClick); optionsEl.appendChild(btn);} ); }
  function onClick(e){ if(lockInput || gameEnded) return; lockInput=true; const rt=(Date.now()-questionStart)/1000; handleAns(parseInt(e.currentTarget.dataset.val,10)===targetIndex+1, rt); }

  function handleAns(ok, rt=0){
    if (gameEnded) return;
    clearInterval(timerId);
    if(ok){
      reactTimes.push(rt);
      play(correctAudio);
      score++;
      updScore();
      level++;
      peopleNum+=2;
      setTimeout(()=>{ lockInput=false; nextQ(); },300);
    } else {
      play(wrongAudio);
      gameEnded = true;
      setTimeout(()=>gameOver(true), 600);
    }
  }

  function nextQ(){ targetIndex=Math.floor(Math.random()*peopleNum); renderLine(); renderOpts(); questionStart=Date.now(); startTimer(10);}  

  function gameOver(triggeredByClick){
    if (gameEnded) {
      lockInput=true;
      optionsEl.innerHTML='';
      timerEl.style.visibility='hidden';
      currentAvgRT = reactTimes.length ? reactTimes.reduce((a,b)=>a+b,0)/reactTimes.length : 0;
      if(qualifies(score)){
        nameInputContainer.style.display = 'block';
        playerNameInput.value = localStorage.getItem(LASTNAME_KEY) || '';
        playerNameInput.focus();
      } else {
        rankingEl.style.display='block';
        renderLB();
        startBtn.style.display='';
      }
    }
  }

  submitNameBtn.addEventListener('click', () => {
    const name = playerNameInput.value.trim();
    if(name){
      localStorage.setItem(LASTNAME_KEY, name);
      recordHS(name, score, currentAvgRT);
      renderLB();
    }
    nameInputContainer.style.display = 'none';
    rankingEl.style.display='block';
    startBtn.style.display='';
  });

  resetBtn.addEventListener('click',()=>{
    const pw = prompt("パスワードを入力してください：");
    if (pw === '0000') {
      localStorage.removeItem(LB_KEY);
      renderLB();
      alert("ランキングをリセットしました。");
    } else if (pw !== null) {
      alert("パスワードが違います。");
    }
  });

  startBtn.addEventListener('click',()=>{ clearInterval(timerId); initGame(); });
  renderLB();
})();
</script>
</body>
</html>
